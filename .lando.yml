name: xtripo
recipe: symfony
excludes:
    - htdocs/vendor
    - htdocs/var/cache
    - htdocs/node_modules
config:
    php: '8.2'
    config:
        php: lando/php/php.ini
        vhosts: lando/apache/000-default.conf
    webroot: htdocs/public
    xdebug: true
    composer_version: 2-latest
services:
    appserver:
        build_as_root:
            - 'a2enmod headers'
        overrides:
            image: 'devwithlando/php:8.2-apache-4'
            build:
                context: ./lando
                dockerfile: Dockerfile
        build:
            - 'composer install -n -d htdocs/'
        run_as_root:
            - 'ln -snf /usr/share/zoneinfo/Europe/Brussels /etc/localtime'
            - 'echo "Europe/Brussels" > /etc/timezone'
    database:
        meUser: root
        type: compose
        creds:
            user: user
            password: password
            database: database
        ports:
            - '33060:3306'
        services:
            image: 'percona/percona-server:8.0'
            environment:
                MYSQL_AUTHENTICATION_PLUGIN: mysql_native_password
                MYSQL_DATABASE: database
                MYSQL_PASSWORD: password
                MYSQL_USER: user
                MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
            command: '/docker-entrypoint.sh --defaults-file=/etc/my.cnf'
            volumes:
                - '$PWD/lando/mysql/my.cnf:/etc/my.cnf.d/my.cnf'
                - 'data_database:/var/lib/mysql'
        volumes:
            data_database: {  }
    phpmyadmin:
        type: phpmyadmin
    node:
        type: 'node:14'
    rabbitmq:
        type: compose
        services:
            image: 'rabbitmq:3-management'
            hostname: rabbit
            command: rabbitmq-server
            ports:
                - '15672:15672'
                - '5672:5672'
            volumes:
                - '$PWD/lando/rabbitmq/rabbitmq-isolated.conf:/etc/rabbitmq/rabbitmq.config'
tooling:
    xdebug-on:
        service: appserver
        description: 'Enable xdebug for apache.'
        cmd: 'docker-php-ext-enable xdebug && /etc/init.d/apache2 reload'
        user: root
    xdebug-off:
        service: appserver
        description: 'Disable xdebug for apache.'
        cmd: 'rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 reload'
        user: root
    yarn:
        service: node
    npm:
        service: node
    rabbit:
        service: rabbitmq
        user: root
        cmd: rabbitmqctl
proxy:
    appserver:
        - xtripo.lndo.site
    rabbitmq:
        - 'rabbit.lndo.site:15672'
